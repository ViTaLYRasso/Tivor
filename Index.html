<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Tivor</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0e0e12;
            --bg2: #13131a;
            --bg3: #1a1a24;
            --bg4: #22222f;
            --border: rgba(255,255,255,0.06);
            --accent: #6c63ff;
            --accent2: #a78bfa;
            --accent-glow: rgba(108,99,255,0.3);
            --text: #e8e8f0;
            --text2: #8888aa;
            --text3: #4a4a6a;
            --mine-bg: linear-gradient(135deg, #6c63ff, #a78bfa);
            --danger: #ff5572;
            --green: #43e97b;
            --radius: 18px;
            --radius-sm: 10px;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:'Manrope',sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; display:flex; align-items:center; justify-content:center; }
        .hidden { display:none !important; }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width:3px; }
        ::-webkit-scrollbar-thumb { background:var(--bg4); border-radius:3px; }

        /* ===== AUTH ===== */
        #auth-screen {
            width:100%; max-width:380px; padding:20px;
            animation: fadeUp 0.5s ease;
        }
        @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
        .auth-card {
            background:var(--bg2);
            border:1px solid var(--border);
            border-radius:24px;
            padding:40px 32px;
            box-shadow: 0 32px 80px rgba(0,0,0,0.6), 0 0 0 1px var(--border);
        }
        .auth-logo {
            text-align:center; margin-bottom:6px;
            font-size:36px; font-weight:800; letter-spacing:-1px;
            background: linear-gradient(135deg, #fff 30%, var(--accent2));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
        }
        .auth-tagline { text-align:center; color:var(--text2); font-size:12px; letter-spacing:2px; margin-bottom:32px; text-transform:uppercase; }
        .auth-tabs { display:flex; background:var(--bg3); border-radius:12px; padding:4px; margin-bottom:28px; gap:4px; }
        .auth-tab { flex:1; padding:10px; text-align:center; border-radius:9px; cursor:pointer; font-size:13px; font-weight:600; color:var(--text2); transition:all 0.2s; }
        .auth-tab.active { background:var(--accent); color:#fff; box-shadow:0 4px 16px var(--accent-glow); }
        .field { margin-bottom:14px; }
        .field label { display:block; font-size:11px; font-weight:600; color:var(--text2); letter-spacing:1px; text-transform:uppercase; margin-bottom:7px; }
        .field input {
            width:100%; background:var(--bg3); border:1px solid var(--border);
            border-radius:12px; padding:13px 16px; color:var(--text);
            font-size:14px; font-family:'Manrope',sans-serif; outline:none; transition:all 0.2s;
        }
        .field input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .btn-main {
            width:100%; padding:14px; border:none; border-radius:12px; cursor:pointer;
            font-size:14px; font-weight:700; font-family:'Manrope',sans-serif;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color:#fff; transition:all 0.2s; margin-top:6px;
            box-shadow:0 4px 20px var(--accent-glow);
        }
        .btn-main:hover { transform:translateY(-1px); box-shadow:0 8px 28px var(--accent-glow); }
        .btn-main:active { transform:translateY(0); }
        .auth-msg { font-size:12px; margin-top:12px; text-align:center; min-height:18px; }
        .auth-msg.err { color:var(--danger); }
        .auth-msg.info { color:var(--accent2); }
        .e2e-note { text-align:center; margin-top:20px; font-size:11px; color:var(--text3); }
        .e2e-note span { color:var(--green); }

        /* ===== APP ===== */
        #app { display:flex; width:100vw; height:100vh; }

        /* ===== SIDEBAR ===== */
        #sidebar {
            width:320px; flex-shrink:0;
            background:var(--bg2);
            border-right:1px solid var(--border);
            display:flex; flex-direction:column;
        }
        .sb-header { padding:20px 20px 16px; border-bottom:1px solid var(--border); }
        .sb-logo { font-size:22px; font-weight:800; letter-spacing:-0.5px; background:linear-gradient(135deg,#fff,var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .sb-user { display:flex; align-items:center; gap:10px; margin-top:14px; }
        .avatar { width:38px; height:38px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:15px; flex-shrink:0; }
        .sb-user-info { flex:1; min-width:0; }
        .sb-nick { font-size:14px; font-weight:600; }
        .sb-email { font-size:11px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .sb-logout { background:none; border:none; cursor:pointer; color:var(--text3); font-size:18px; padding:4px; border-radius:8px; transition:color 0.2s; }
        .sb-logout:hover { color:var(--danger); }
        .sb-actions { display:flex; gap:8px; padding:14px 16px; border-bottom:1px solid var(--border); }
        .sb-btn {
            flex:1; padding:9px 0; border-radius:10px; border:none; cursor:pointer;
            font-size:12px; font-weight:600; font-family:'Manrope',sans-serif;
            background:var(--bg3); color:var(--accent2); transition:all 0.2s;
        }
        .sb-btn:hover { background:var(--accent); color:#fff; }
        .sb-tabs { display:flex; padding:0 16px; border-bottom:1px solid var(--border); }
        .sb-tab { flex:1; padding:12px 0; text-align:center; font-size:12px; font-weight:600; color:var(--text3); cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; }
        .sb-tab.active { color:var(--accent2); border-bottom-color:var(--accent); }
        .sb-search { padding:12px 16px; border-bottom:1px solid var(--border); }
        .sb-search input { width:100%; background:var(--bg3); border:1px solid var(--border); border-radius:10px; padding:9px 14px; color:var(--text); font-size:13px; font-family:'Manrope',sans-serif; outline:none; transition:border-color 0.2s; }
        .sb-search input:focus { border-color:var(--accent); }
        #chat-list { flex:1; overflow-y:auto; padding:8px; }
        .chat-item { display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:14px; cursor:pointer; transition:background 0.15s; margin-bottom:2px; }
        .chat-item:hover { background:var(--bg3); }
        .chat-item.active { background:rgba(108,99,255,0.12); }
        .ci-info { flex:1; min-width:0; }
        .ci-name { font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .ci-preview { font-size:12px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px; }
        .ci-time { font-size:11px; color:var(--text3); flex-shrink:0; }

        /* ===== CHAT AREA ===== */
        #chat-area { flex:1; display:flex; flex-direction:column; min-width:0; background:var(--bg); }
        #empty-state { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; color:var(--text3); }
        .empty-logo { font-size:56px; font-weight:800; background:linear-gradient(135deg,var(--bg3),var(--bg4)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        #empty-state p { font-size:14px; }

        /* ===== CHAT VIEW ===== */
        #chat-view { display:none; flex-direction:column; height:100%; }
        #chat-view.open { display:flex; }
        #chat-header {
            padding:14px 20px; background:var(--bg2); border-bottom:1px solid var(--border);
            display:flex; align-items:center; gap:12px;
            backdrop-filter:blur(20px);
        }
        #btn-back { display:none; background:none; border:none; cursor:pointer; color:var(--text2); font-size:22px; padding:2px 8px 2px 0; }
        .ch-info { flex:1; }
        .ch-name { font-size:16px; font-weight:700; }
        .ch-sub { font-size:11px; color:var(--text2); margin-top:1px; }
        .ch-e2e { font-size:10px; color:var(--green); background:rgba(67,233,123,0.1); border:1px solid rgba(67,233,123,0.2); padding:3px 10px; border-radius:20px; font-weight:600; }

        /* ===== MESSAGES ===== */
        #messages { flex:1; overflow-y:auto; padding:20px 16px; display:flex; flex-direction:column; gap:4px; }
        .date-sep { text-align:center; margin:12px 0; }
        .date-sep span { font-size:11px; color:var(--text3); background:var(--bg2); border:1px solid var(--border); padding:4px 14px; border-radius:20px; }

        .msg-row { display:flex; align-items:flex-end; gap:8px; max-width:100%; }
        .msg-row.mine { flex-direction:row-reverse; }
        .msg-row + .msg-row { margin-top:2px; }
        .msg-row.gap-top { margin-top:10px; }

        .msg-avatar { width:30px; height:30px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; flex-shrink:0; margin-bottom:2px; }
        .msg-avatar.hidden-av { visibility:hidden; }

        .msg-bubble {
            max-width:72%; padding:10px 14px; border-radius:18px;
            font-size:14px; line-height:1.55; word-break:break-word;
            background:var(--bg3); border:1px solid var(--border);
            position:relative; cursor:pointer; transition:filter 0.15s;
        }
        .msg-bubble:active { filter:brightness(1.15); }
        .msg-row.mine .msg-bubble {
            background:var(--mine-bg); border:none; color:#fff;
        }
        .msg-bubble.selected { outline:2px solid var(--accent); }
        .msg-sender { font-size:11px; font-weight:700; color:var(--accent2); margin-bottom:4px; }
        .msg-row.mine .msg-sender { display:none; }
        .msg-footer { display:flex; align-items:center; gap:5px; margin-top:5px; justify-content:flex-end; }
        .msg-time { font-size:10px; color:rgba(255,255,255,0.4); }
        .msg-row:not(.mine) .msg-time { color:var(--text3); }
        .lock-ic { font-size:9px; color:rgba(67,233,123,0.6); }
        .msg-edited { font-size:10px; color:rgba(255,255,255,0.35); font-style:italic; }
        .msg-row:not(.mine) .msg-edited { color:var(--text3); }

        /* Photo message */
        .msg-photo { max-width:260px; max-height:300px; border-radius:12px; display:block; cursor:pointer; object-fit:cover; }
        .msg-photo-wrap { position:relative; }
        .photo-loading { width:200px; height:140px; background:var(--bg4); border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--text3); font-size:12px; }

        /* Forwarded */
        .msg-fwd { border-left:3px solid var(--accent2); padding-left:10px; margin-bottom:6px; font-size:12px; color:var(--accent2); }
        .msg-fwd-from { font-weight:600; }
        .msg-fwd-text { color:var(--text2); margin-top:2px; }

        /* Encrypted fail */
        .msg-enc-fail { color:var(--text3); font-style:italic; font-size:13px; }

        /* ===== CONTEXT MENU ===== */
        #ctx-menu {
            position:fixed; z-index:200; background:var(--bg2);
            border:1px solid var(--border); border-radius:16px;
            overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.7);
            min-width:200px; animation:ctxIn 0.15s ease;
        }
        @keyframes ctxIn { from{opacity:0;transform:scale(0.92)} to{opacity:1;transform:scale(1)} }
        .ctx-item { display:flex; align-items:center; gap:12px; padding:13px 18px; cursor:pointer; font-size:14px; font-weight:500; transition:background 0.15s; }
        .ctx-item:hover { background:var(--bg3); }
        .ctx-item.danger { color:var(--danger); }
        .ctx-ic { font-size:16px; width:20px; text-align:center; }
        .ctx-divider { height:1px; background:var(--border); margin:4px 0; }

        /* ===== FORWARD MODAL ===== */
        #fwd-list { max-height:240px; overflow-y:auto; margin-top:10px; }
        .fwd-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; cursor:pointer; transition:background 0.15s; }
        .fwd-item:hover { background:var(--bg3); }

        /* ===== INPUT AREA ===== */
        #input-area {
            padding:14px 16px; background:var(--bg2); border-top:1px solid var(--border);
            display:flex; align-items:flex-end; gap:10px;
        }
        #input-wrap { flex:1; background:var(--bg3); border:1px solid var(--border); border-radius:16px; display:flex; align-items:flex-end; padding:10px 14px; gap:8px; transition:border-color 0.2s; }
        #input-wrap:focus-within { border-color:var(--accent); }
        #msg-input { flex:1; background:none; border:none; outline:none; color:var(--text); font-size:14px; font-family:'Manrope',sans-serif; resize:none; max-height:120px; line-height:1.5; }
        #msg-input::placeholder { color:var(--text3); }
        .input-photo-btn { background:none; border:none; cursor:pointer; color:var(--text2); font-size:20px; padding:0; line-height:1; transition:color 0.2s; flex-shrink:0; }
        .input-photo-btn:hover { color:var(--accent2); }
        #btn-send {
            width:46px; height:46px; border-radius:50%; border:none; cursor:pointer;
            background:linear-gradient(135deg,var(--accent),var(--accent2));
            color:#fff; font-size:18px; flex-shrink:0;
            display:flex; align-items:center; justify-content:center;
            box-shadow:0 4px 16px var(--accent-glow); transition:all 0.2s;
        }
        #btn-send:hover { transform:scale(1.08); }
        #btn-send:active { transform:scale(0.96); }
        #file-input { display:none; }

        /* Edit bar */
        #edit-bar { display:none; padding:10px 16px; background:var(--bg2); border-top:1px solid var(--border); border-bottom:1px solid var(--border); font-size:13px; color:var(--accent2); display:none; align-items:center; gap:8px; }
        #edit-bar.show { display:flex; }
        #edit-cancel { margin-left:auto; background:none; border:none; cursor:pointer; color:var(--text2); font-size:18px; }

        /* ===== MODALS ===== */
        .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); align-items:center; justify-content:center; z-index:150; padding:20px; }
        .modal-overlay.open { display:flex; }
        .modal { background:var(--bg2); border:1px solid var(--border); border-radius:24px; padding:28px; width:100%; max-width:360px; box-shadow:0 32px 80px rgba(0,0,0,0.6); animation:fadeUp 0.25s ease; }
        .modal h3 { font-size:18px; font-weight:700; margin-bottom:20px; }
        .modal-field { margin-bottom:14px; }
        .modal-field label { display:block; font-size:11px; font-weight:600; color:var(--text2); letter-spacing:1px; text-transform:uppercase; margin-bottom:7px; }
        .modal-field input { width:100%; background:var(--bg3); border:1px solid var(--border); border-radius:12px; padding:12px 14px; color:var(--text); font-size:14px; font-family:'Manrope',sans-serif; outline:none; transition:border-color 0.2s; }
        .modal-field input:focus { border-color:var(--accent); }
        .modal-actions { display:flex; gap:10px; margin-top:20px; }
        .btn-ghost { flex:1; padding:12px; border:1px solid var(--border); border-radius:12px; background:none; color:var(--text2); cursor:pointer; font-size:14px; font-weight:600; font-family:'Manrope',sans-serif; transition:all 0.2s; }
        .btn-ghost:hover { border-color:var(--accent2); color:var(--text); }
        .btn-accent { flex:1; padding:12px; border:none; border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; cursor:pointer; font-size:14px; font-weight:700; font-family:'Manrope',sans-serif; }
        .search-results { max-height:200px; overflow-y:auto; margin-top:12px; }
        .s-result { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; cursor:pointer; transition:background 0.15s; }
        .s-result:hover { background:var(--bg3); }
        .s-result-info b { display:block; font-size:14px; font-weight:600; }
        .s-result-info small { font-size:12px; color:var(--text2); }
        .chip-wrap { margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
        .chip { display:inline-flex; align-items:center; gap:6px; background:rgba(108,99,255,0.15); border:1px solid rgba(108,99,255,0.3); border-radius:20px; padding:5px 12px; font-size:12px; color:var(--accent2); }
        .chip-x { cursor:pointer; color:var(--text2); font-size:11px; }
        .chip-x:hover { color:var(--danger); }

        /* Photo lightbox */
        #lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:300; align-items:center; justify-content:center; cursor:pointer; }
        #lightbox.open { display:flex; }
        #lightbox img { max-width:92vw; max-height:92vh; border-radius:12px; object-fit:contain; }

        /* ===== MOBILE ===== */
        @media (max-width:680px) {
            #app { position:relative; overflow:hidden; }
            #sidebar { width:100vw; position:absolute; inset:0; z-index:10; transition:transform 0.3s cubic-bezier(.4,0,.2,1); }
            #chat-area { width:100vw; position:absolute; inset:0; z-index:20; transform:translateX(100%); transition:transform 0.3s cubic-bezier(.4,0,.2,1); background:var(--bg); }
            #chat-area.slide-in { transform:translateX(0); }
            #btn-back { display:block; }
        }
    </style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen">
    <div class="auth-card">
        <div class="auth-logo">Tivor</div>
        <div class="auth-tagline">üîí End-to-end encrypted</div>
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchTab('login')">–í–æ–π—Ç–∏</div>
            <div class="auth-tab" onclick="switchTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>
        <div id="tab-login">
            <div class="field"><label>Email</label><input type="email" id="login-email" placeholder="you@example.com"></div>
            <div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
            <button class="btn-main" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        </div>
        <div id="tab-register" class="hidden">
            <div class="field"><label>NickName</label><input type="text" id="reg-nick" placeholder="nickname_123"></div>
            <div class="field"><label>Email</label><input type="email" id="reg-email" placeholder="you@example.com"></div>
            <div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="reg-pass" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"></div>
            <button class="btn-main" onclick="doRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <div class="auth-msg info" id="auth-info"></div>
        </div>
        <div class="auth-msg err" id="auth-error"></div>
        <div class="e2e-note"><span>üîí</span> –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</div>
    </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
    <!-- SIDEBAR -->
    <div id="sidebar">
        <div class="sb-header">
            <div class="sb-logo">Tivor</div>
            <div class="sb-user">
                <div class="avatar" id="my-avatar">?</div>
                <div class="sb-user-info">
                    <div class="sb-nick" id="my-nick">@nick</div>
                    <div class="sb-email" id="my-email">email</div>
                </div>
                <button class="sb-logout" onclick="doLogout()" title="–í—ã–π—Ç–∏">‚èª</button>
            </div>
        </div>
        <div class="sb-actions">
            <button class="sb-btn" onclick="openModal('modal-dm')">‚úâ –ù–æ–≤—ã–π —á–∞—Ç</button>
            <button class="sb-btn" onclick="openModal('modal-group')">üë• –ì—Ä—É–ø–ø–∞</button>
        </div>
        <div class="sb-tabs">
            <div class="sb-tab active" onclick="setSideTab('all',this)">–í—Å–µ</div>
            <div class="sb-tab" onclick="setSideTab('dm',this)">–õ–∏—á–Ω—ã–µ</div>
            <div class="sb-tab" onclick="setSideTab('group',this)">–ì—Ä—É–ø–ø—ã</div>
        </div>
        <div class="sb-search"><input placeholder="üîç –ü–æ–∏—Å–∫..." oninput="filterChats(this.value)" id="chat-search"></div>
        <div id="chat-list"></div>
    </div>

    <!-- CHAT AREA -->
    <div id="chat-area">
        <div id="empty-state">
            <div class="empty-logo">Tivor</div>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
        </div>
        <div id="chat-view">
            <div id="chat-header">
                <button id="btn-back" onclick="goBack()">‚Äπ</button>
                <div class="avatar" id="ch-avatar" style="width:36px;height:36px;font-size:14px;">?</div>
                <div class="ch-info">
                    <div class="ch-name" id="ch-name">‚Äî</div>
                    <div class="ch-sub" id="ch-sub">‚Äî</div>
                </div>
                <div class="ch-e2e">üîí E2E</div>
            </div>
            <div id="edit-bar">
                <span>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                <button id="edit-cancel" onclick="cancelEdit()">‚úï</button>
            </div>
            <div id="messages"></div>
            <div id="input-area">
                <div id="input-wrap">
                    <button class="input-photo-btn" onclick="document.getElementById('file-input').click()" title="–§–æ—Ç–æ">üñº</button>
                    <textarea id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." rows="1" onkeydown="handleEnter(event)" oninput="autoResize(this)"></textarea>
                </div>
                <button id="btn-send" onclick="sendMessage()">‚û§</button>
                <input type="file" id="file-input" accept="image/*" onchange="handlePhoto(this)">
            </div>
        </div>
    </div>
</div>

<!-- MODAL: New DM -->
<div class="modal-overlay" id="modal-dm">
    <div class="modal">
        <h3>–ù–æ–≤—ã–π —á–∞—Ç</h3>
        <div class="modal-field"><label>Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label><input type="email" id="dm-email" placeholder="user@example.com" oninput="searchUserDm(this.value)"></div>
        <div class="search-results" id="dm-results"></div>
        <div class="modal-actions"><button class="btn-ghost" onclick="closeModal('modal-dm')">–û—Ç–º–µ–Ω–∞</button></div>
    </div>
</div>

<!-- MODAL: New Group -->
<div class="modal-overlay" id="modal-group">
    <div class="modal">
        <h3>–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</h3>
        <div class="modal-field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="grp-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"></div>
        <div class="modal-field"><label>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ email</label><input type="email" id="grp-email" placeholder="user@example.com" oninput="searchUserGrp(this.value)"></div>
        <div class="search-results" id="grp-results"></div>
        <div class="chip-wrap" id="grp-chips"></div>
        <div class="modal-actions">
            <button class="btn-ghost" onclick="closeModal('modal-group')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-accent" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- MODAL: Forward -->
<div class="modal-overlay" id="modal-fwd">
    <div class="modal">
        <h3>–ü–µ—Ä–µ—Å–ª–∞—Ç—å –≤...</h3>
        <div id="fwd-list"></div>
        <div class="modal-actions"><button class="btn-ghost" onclick="closeModal('modal-fwd')">–û—Ç–º–µ–Ω–∞</button></div>
    </div>
</div>

<!-- CONTEXT MENU -->
<div id="ctx-menu" style="display:none;">
    <div class="ctx-item" onclick="ctxCopy()"><span class="ctx-ic">üìã</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
    <div class="ctx-item" id="ctx-edit-btn" onclick="ctxEdit()"><span class="ctx-ic">‚úèÔ∏è</span> –ò–∑–º–µ–Ω–∏—Ç—å</div>
    <div class="ctx-item" onclick="ctxForward()"><span class="ctx-ic">‚Ü™Ô∏è</span> –ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
    <div class="ctx-divider"></div>
    <div class="ctx-item danger" onclick="ctxDelete()"><span class="ctx-ic">üóë</span> –£–¥–∞–ª–∏—Ç—å</div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox" onclick="this.classList.remove('open')">
    <img id="lightbox-img" src="">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getDatabase, ref, set, get, push, onValue, off, update, remove }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDdTU9PT2cZij92fuATe8zA37P_JmtiTBs",
    authDomain: "vital-messenger.firebaseapp.com",
    databaseURL: "https://vital-messenger-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "vital-messenger",
    storageBucket: "vital-messenger.firebasestorage.app",
    messagingSenderId: "372669990608",
    appId: "1:372669990608:web:de9367ef97f7d923de00d5",
    measurementId: "G-YH3DM8GGKX"
};

const fireApp = initializeApp(firebaseConfig);
const auth = getAuth(fireApp);
const db = getDatabase(fireApp);


// ============================================================
// ======= ECDH + AES-GCM E2E ENCRYPTION =====================
// ============================================================
const STORAGE_PRIV = 'tivor_pk_';
const ALG_ECDH = { name:'ECDH', namedCurve:'P-256' };
const ALG_AES  = { name:'AES-GCM', length:256 };

const b64enc = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
const b64dec = s => Uint8Array.from(atob(s), c => c.charCodeAt(0));

async function exportPub(k)  { return b64enc(await crypto.subtle.exportKey('spki', k)); }
async function exportPriv(k) { return b64enc(await crypto.subtle.exportKey('pkcs8', k)); }
async function importPub(s)  { return crypto.subtle.importKey('spki',  b64dec(s), ALG_ECDH, true, []); }
async function importPriv(s) { return crypto.subtle.importKey('pkcs8', b64dec(s), ALG_ECDH, true, ['deriveKey']); }

async function getOrCreateKeys(uid) {
    const stored = localStorage.getItem(STORAGE_PRIV + uid);
    if (stored) {
        try {
            const priv = await importPriv(stored);
            const snap = await get(ref(db, 'users/'+uid+'/publicKey'));
            if (snap.exists()) { const pub = await importPub(snap.val()); return {privateKey:priv, publicKey:pub}; }
        } catch(e) {}
    }
    const pair = await crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'}, true, ['deriveKey']);
    localStorage.setItem(STORAGE_PRIV+uid, await exportPriv(pair.privateKey));
    await update(ref(db,'users/'+uid), { publicKey: await exportPub(pair.publicKey) });
    return pair;
}

async function deriveAES(myPriv, theirPubB64) {
    const pub = await importPub(theirPubB64);
    return crypto.subtle.deriveKey({name:'ECDH', public:pub}, myPriv, ALG_AES, false, ['encrypt','decrypt']);
}

async function deriveGroupAES(chatId) {
    const enc = new TextEncoder();
    const km = await crypto.subtle.importKey('raw', enc.encode('tivor-g-'+chatId), 'PBKDF2', false, ['deriveKey']);
    return crypto.subtle.deriveKey({name:'PBKDF2',salt:enc.encode(chatId),iterations:100000,hash:'SHA-256'}, km, ALG_AES, false, ['encrypt','decrypt']);
}

async function encryptText(text, key) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, new TextEncoder().encode(text));
    return b64enc(iv) + ':' + b64enc(ct);
}

async function decryptText(payload, key) {
    try {
        const [ivB, ctB] = payload.split(':');
        const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv:b64dec(ivB)}, key, b64dec(ctB));
        return new TextDecoder().decode(pt);
    } catch { return null; }
}

const keyCache = {};
async function getKey(chat) {
    if (keyCache[chat.id]) return keyCache[chat.id];
    let k;
    if (chat.type === 'dm') {
        const otherUid = Object.keys(chat.members||{}).find(u=>u!==currentUser.uid);
        const snap = await get(ref(db,'users/'+otherUid+'/publicKey'));
        if (!snap.exists()) return null;
        k = await deriveAES(myKeys.privateKey, snap.val());
    } else {
        k = await deriveGroupAES(chat.id);
    }
    keyCache[chat.id] = k;
    return k;
}

// ============================================================
// ======= STATE =============================================
// ============================================================
let currentUser = null, myNick = '', myKeys = null;
let currentChat = null, allChats = [], sideTab = 'all';
let groupMembers = {}, searchTimer = null, prevChatId = null;
let ctxMsg = null, ctxMsgId = null, ctxMsgKey = null;
let editingMsgId = null;

// ============================================================
// ======= HELPERS ============================================
// ============================================================
function getNick(u) { return u.nickName||u.nickname||u.NickName||u.nick||u.name||(u.email?.split('@')[0])||'User'; }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fmtTime(ts) { if(!ts)return''; const d=new Date(ts); return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0'); }
function fmtDate(ts) {
    if(!ts)return''; const d=new Date(ts), t=new Date();
    if(d.toDateString()===t.toDateString()) return '–°–µ–≥–æ–¥–Ω—è';
    const y=new Date(); y.setDate(t.getDate()-1);
    if(d.toDateString()===y.toDateString()) return '–í—á–µ—Ä–∞';
    return d.toLocaleDateString('ru-RU',{day:'numeric',month:'long'});
}
function authErr(code) {
    const m={'auth/email-already-in-use':'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è','auth/invalid-email':'–ù–µ–≤–µ—Ä–Ω—ã–π email','auth/weak-password':'–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π','auth/user-not-found':'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','auth/wrong-password':'–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å','auth/invalid-credential':'–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å','auth/too-many-requests':'–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫'};
    return m[code]||'–û—à–∏–±–∫–∞: '+code;
}
function initials(name) { return (name||'?')[0].toUpperCase(); }
function avatarColor(name) {
    const colors = ['#6c63ff','#a78bfa','#f59e0b','#10b981','#3b82f6','#ec4899','#14b8a6'];
    let h=0; for(const c of (name||'?')) h=(h<<5)-h+c.charCodeAt(0)|0;
    return colors[Math.abs(h)%colors.length];
}

// ============================================================
// ======= AUTH ===============================================
// ============================================================
window.switchTab = tab => {
    document.getElementById('tab-login').classList.toggle('hidden', tab!=='login');
    document.getElementById('tab-register').classList.toggle('hidden', tab!=='register');
    document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',(i===0&&tab==='login')||(i===1&&tab==='register')));
    document.getElementById('auth-error').textContent='';
};

window.doRegister = async () => {
    const nick=document.getElementById('reg-nick').value.trim();
    const email=document.getElementById('reg-email').value.trim();
    const pass=document.getElementById('reg-pass').value;
    const errEl=document.getElementById('auth-error');
    const infoEl=document.getElementById('auth-info');
    errEl.textContent=''; infoEl.textContent='';
    if(!nick||!email||!pass){errEl.textContent='–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';return;}
    if(nick.length<3){errEl.textContent='NickName –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';return;}
    if(!/^[a-zA-Z0-9_–∞-—è–ê-–Ø]+$/.test(nick)){errEl.textContent='NickName: –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _';return;}
    if(pass.length<6){errEl.textContent='–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';return;}
    infoEl.textContent='–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞...';
    try {
        const cred=await createUserWithEmailAndPassword(auth,email,pass);
        const uid=cred.user.uid;
        infoEl.textContent='–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...';
        const pair=await crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'},true,['deriveKey']);
        const privB=await exportPriv(pair.privateKey);
        const pubB=await exportPub(pair.publicKey);
        localStorage.setItem(STORAGE_PRIV+uid,privB);
        infoEl.textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        await set(ref(db,'users/'+uid),{uid,nickName:nick,nickLower:nick.toLowerCase(),email,emailLower:email.toLowerCase(),publicKey:pubB,createdAt:Date.now()});
        infoEl.textContent='–ì–æ—Ç–æ–≤–æ! üîí';
    } catch(e){console.error(e);infoEl.textContent='';errEl.textContent=authErr(e.code);}
};

window.doLogin = async () => {
    const email=document.getElementById('login-email').value.trim();
    const pass=document.getElementById('login-pass').value;
    const errEl=document.getElementById('auth-error');
    errEl.textContent='';
    if(!email||!pass){errEl.textContent='–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å';return;}
    try{await signInWithEmailAndPassword(auth,email,pass);}
    catch(e){console.error(e);errEl.textContent=authErr(e.code);}
};

window.doLogout = () => { Object.keys(keyCache).forEach(k=>delete keyCache[k]); signOut(auth); };

onAuthStateChanged(auth, async user => {
    if(user){
        currentUser=user;
        const snap=await get(ref(db,'users/'+user.uid));
        let data;
        if(snap.exists()){data=snap.val();}
        else{
            myNick=user.email.split('@')[0];
            data={uid:user.uid,nickName:myNick,email:user.email,emailLower:user.email.toLowerCase(),createdAt:Date.now()};
            await set(ref(db,'users/'+user.uid),data);
        }
        myNick=getNick(data);
        myKeys=await getOrCreateKeys(user.uid);
        const col=avatarColor(myNick);
        document.getElementById('my-avatar').textContent=initials(myNick);
        document.getElementById('my-avatar').style.background=`linear-gradient(135deg,${col},${col}88)`;
        document.getElementById('my-nick').textContent='@'+myNick;
        document.getElementById('my-email').textContent=user.email;
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        loadChats();
    } else {
        currentUser=null; myNick=''; myKeys=null; currentChat=null; allChats=[];
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('app').classList.add('hidden');
        document.getElementById('chat-list').innerHTML='';
    }
});

// ============================================================
// ======= CHATS ==============================================
// ============================================================
function loadChats(){
    onValue(ref(db,'chats'),snap=>{
        allChats=[];
        if(snap.exists()){
            Object.entries(snap.val()).forEach(([id,c])=>{
                if(c.members&&c.members[currentUser.uid]) allChats.push({id,...c});
            });
            allChats.sort((a,b)=>(b.lastAt||0)-(a.lastAt||0));
        }
        renderChats('');
    });
}

function renderChats(filter){
    const list=document.getElementById('chat-list');
    list.innerHTML='';
    let items=allChats;
    if(filter) items=items.filter(c=>getChatName(c).toLowerCase().includes(filter.toLowerCase()));
    if(sideTab==='dm') items=items.filter(c=>c.type==='dm');
    if(sideTab==='group') items=items.filter(c=>c.type==='group');
    if(!items.length){
        list.innerHTML='<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px;">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
        return;
    }
    items.forEach(chat=>{
        const name=getChatName(chat);
        const col=avatarColor(name);
        const div=document.createElement('div');
        div.className='chat-item'+(currentChat?.id===chat.id?' active':'');
        div.innerHTML=`
            <div class="avatar" style="background:linear-gradient(135deg,${col},${col}88)">${initials(name)}</div>
            <div class="ci-info">
                <div class="ci-name">${esc(name)}</div>
                <div class="ci-preview">üîí ${esc(chat.lastMsg||'–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π')}</div>
            </div>
            <div class="ci-time">${fmtTime(chat.lastAt)}</div>
        `;
        div.onclick=()=>openChat(chat);
        list.appendChild(div);
    });
}

function getChatName(chat){
    if(chat.type==='group') return chat.name||'–ì—Ä—É–ø–ø–∞';
    const uid=Object.keys(chat.members||{}).find(u=>u!==currentUser.uid);
    return '@'+(chat.memberNicks?.[uid]||'?');
}

// ============================================================
// ======= OPEN CHAT ==========================================
// ============================================================
async function openChat(chat){
    currentChat=chat;
    document.getElementById('empty-state').style.display='none';
    document.getElementById('chat-view').classList.add('open');
    document.getElementById('chat-area').classList.add('slide-in');
    const name=getChatName(chat);
    const col=avatarColor(name);
    document.getElementById('ch-name').textContent=name;
    document.getElementById('ch-avatar').textContent=initials(name);
    document.getElementById('ch-avatar').style.background=`linear-gradient(135deg,${col},${col}88)`;
    document.getElementById('ch-sub').textContent=chat.type==='group'?Object.keys(chat.members||{}).length+' —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤':(chat.memberEmails?.[Object.keys(chat.members||{}).find(u=>u!==currentUser.uid)]||'');
    cancelEdit();
    renderChats('');
    loadMessages(chat);
}

// ============================================================
// ======= MESSAGES ===========================================
// ============================================================
function loadMessages(chat){
    if(prevChatId&&prevChatId!==chat.id) off(ref(db,'messages/'+prevChatId));
    prevChatId=chat.id;
    document.getElementById('messages').innerHTML='<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    onValue(ref(db,'messages/'+chat.id), async snap=>{
        const area=document.getElementById('messages');
        area.innerHTML='';
        if(!snap.exists()) return;
        const key=await getKey(chat);
        const msgs=Object.entries(snap.val()).sort((a,b)=>a[1].timestamp-b[1].timestamp);
        let lastDate='', lastUid='';
        for(const [msgId,msg] of msgs){
            const ds=fmtDate(msg.timestamp);
            if(ds!==lastDate){
                lastDate=ds;
                const sep=document.createElement('div');
                sep.className='date-sep';
                sep.innerHTML=`<span>${ds}</span>`;
                area.appendChild(sep);
                lastUid='';
            }
            const mine=msg.uid===currentUser.uid;
            const gapTop=lastUid&&lastUid!==msg.uid;
            lastUid=msg.uid;

            // Decrypt text
            let text='', isFail=false, isPhoto=false;
            if(msg.photo){ isPhoto=true; text=msg.photo; }
            else if(key&&msg.enc){ const d=await decryptText(msg.enc,key); if(d!==null)text=d; else{text='[ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å ]';isFail=true;} }
            else if(msg.text){ text=msg.text; }
            else { text='[ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ ]'; isFail=true; }

            const row=document.createElement('div');
            row.className='msg-row'+(mine?' mine':'')+(gapTop?' gap-top':'');
            row.dataset.id=msgId;
            row.dataset.uid=msg.uid;
            row.dataset.text=text;
            row.dataset.photo=isPhoto?'1':'';

            const showAv=!mine&&(!lastUid||gapTop);
            let bubbleContent='';

            if(msg.forwardFrom){
                bubbleContent+=`<div class="msg-fwd"><div class="msg-fwd-from">‚Ü™ ${esc(msg.forwardFrom)}</div><div class="msg-fwd-text">${esc(msg.forwardText||'').substring(0,60)}</div></div>`;
            }
            if(!mine&&gapTop){
                bubbleContent+=`<div class="msg-sender">@${esc(msg.senderNick||'?')}</div>`;
            }
            if(isPhoto){
                bubbleContent+=`<img class="msg-photo" src="${esc(text)}" onclick="openLightbox('${esc(text)}')" loading="lazy" onerror="this.style.display='none'">`;
            } else {
                bubbleContent+=`<div class="${isFail?'msg-enc-fail':''}">${esc(text).replace(/\n/g,'<br>')}</div>`;
            }
            bubbleContent+=`<div class="msg-footer"><span class="lock-ic">üîí</span><span class="msg-time">${fmtTime(msg.timestamp)}</span>${msg.edited?'<span class="msg-edited">–∏–∑–º.</span>':''}</div>`;

            row.innerHTML=`
                ${!mine?`<div class="msg-avatar${showAv?'':' hidden-av'}" style="background:linear-gradient(135deg,${avatarColor(msg.senderNick||'?')},${avatarColor(msg.senderNick||'?')}88)">${initials(msg.senderNick||'?')}</div>`:''}
                <div class="msg-bubble">${bubbleContent}</div>
            `;
            // Long press / right click context menu
            const bubble=row.querySelector('.msg-bubble');
            bubble.addEventListener('contextmenu',e=>{e.preventDefault();showCtx(e,msgId,msg,text,key,mine);});
            let pressTimer;
            bubble.addEventListener('touchstart',()=>{ pressTimer=setTimeout(()=>{ const r=bubble.getBoundingClientRect(); showCtx({clientX:r.left+r.width/2,clientY:r.top},msgId,msg,text,key,mine); },500); });
            bubble.addEventListener('touchend',()=>clearTimeout(pressTimer));
            bubble.addEventListener('touchmove',()=>clearTimeout(pressTimer));

            area.appendChild(row);
        }
        area.scrollTop=area.scrollHeight;
    });
}

// ============================================================
// ======= SEND MESSAGE =======================================
// ============================================================
window.sendMessage = async () => {
    const input=document.getElementById('msg-input');
    const text=input.value.trim();
    if(!text||!currentChat) return;
    input.value=''; input.style.height='auto';

    if(editingMsgId){
        // Edit existing message
        const key=await getKey(currentChat);
        let updateData={edited:true};
        if(key){ updateData.enc=await encryptText(text,key); }
        else { updateData.text=text; }
        await update(ref(db,'messages/'+currentChat.id+'/'+editingMsgId), updateData);
        cancelEdit();
        return;
    }

    const key=await getKey(currentChat);
    let msgData={ uid:currentUser.uid, senderNick:myNick, timestamp:Date.now() };
    if(key){ msgData.enc=await encryptText(text,key); }
    else { msgData.text=text; }

    await push(ref(db,'messages/'+currentChat.id), msgData);
    await update(ref(db,'chats/'+currentChat.id),{ lastMsg:'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ', lastAt:Date.now() });
};

window.handleEnter = e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} };
window.autoResize = el=>{ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; };

// ============================================================
// ======= PHOTO UPLOAD (Base64 ‚Üí Firebase) =================
// ============================================================
window.handlePhoto = async input => {
    const file=input.files[0]; if(!file||!currentChat) return;
    input.value='';
    const area=document.getElementById('messages');
    const loadDiv=document.createElement('div');
    loadDiv.className='msg-row mine gap-top';
    loadDiv.innerHTML='<div class="msg-bubble"><div class="photo-loading">üì§ –°–∂–∞—Ç–∏–µ —Ñ–æ—Ç–æ...</div></div>';
    area.appendChild(loadDiv);
    area.scrollTop=area.scrollHeight;

    try {
        // –°–∂–∏–º–∞–µ–º –¥–æ ~800px –∏ –∫–∞—á–µ—Å—Ç–≤–æ 0.7 —á—Ç–æ–±—ã —É–ª–æ–∂–∏—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç—ã Firebase
        const base64=await compressImage(file, 800, 0.70);

        loadDiv.querySelector('.photo-loading').textContent='üì§ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º base64 –ø—Ä—è–º–æ –≤ Firebase ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞
        await push(ref(db,'messages/'+currentChat.id),{
            uid:currentUser.uid, senderNick:myNick,
            photo:base64, timestamp:Date.now()
        });
        await update(ref(db,'chats/'+currentChat.id),{ lastMsg:'üñº –§–æ—Ç–æ', lastAt:Date.now() });
        loadDiv.remove();
    } catch(e) {
        loadDiv.remove();
        console.error('Photo error:',e);
        if(e.message&&e.message.includes('larger than')) {
            alert('–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ: '+e.message);
        }
    }
};

async function compressImage(file, maxW, quality){
    return new Promise(resolve=>{
        const img=new Image();
        const reader=new FileReader();
        reader.onload=e=>{ img.src=e.target.result; };
        img.onload=()=>{
            const canvas=document.createElement('canvas');
            let w=img.width, h=img.height;
            if(w>maxW){ h=h*(maxW/w); w=maxW; }
            canvas.width=w; canvas.height=h;
            canvas.getContext('2d').drawImage(img,0,0,w,h);
            resolve(canvas.toDataURL('image/jpeg',quality));
        };
        reader.readAsDataURL(file);
    });
}

window.openLightbox = url=>{
    document.getElementById('lightbox-img').src=url;
    document.getElementById('lightbox').classList.add('open');
};

// ============================================================
// ======= CONTEXT MENU =======================================
// ============================================================
function showCtx(e, msgId, msg, text, key, mine){
    ctxMsg=msg; ctxMsgId=msgId; ctxMsgKey=key;
    const menu=document.getElementById('ctx-menu');
    document.getElementById('ctx-edit-btn').style.display=mine&&!msg.photo?'flex':'none';
    menu.style.display='block';
    let x=e.clientX, y=e.clientY;
    menu.style.left=x+'px'; menu.style.top=y+'px';
    // Adjust if off screen
    requestAnimationFrame(()=>{
        const r=menu.getBoundingClientRect();
        if(r.right>window.innerWidth) menu.style.left=(window.innerWidth-r.width-8)+'px';
        if(r.bottom>window.innerHeight) menu.style.top=(y-r.height)+'px';
    });
}

document.addEventListener('click',e=>{
    const menu=document.getElementById('ctx-menu');
    if(!menu.contains(e.target)) menu.style.display='none';
});

window.ctxCopy = async()=>{
    document.getElementById('ctx-menu').style.display='none';
    if(!ctxMsg) return;
    let text='';
    if(ctxMsg.photo){ text=ctxMsg.photo; }
    else if(ctxMsgKey&&ctxMsg.enc){ text=await decryptText(ctxMsg.enc,ctxMsgKey)||''; }
    else { text=ctxMsg.text||''; }
    navigator.clipboard?.writeText(text).catch(()=>{});
};

window.ctxEdit = ()=>{
    document.getElementById('ctx-menu').style.display='none';
    if(!ctxMsg||ctxMsg.uid!==currentUser.uid) return;
    editingMsgId=ctxMsgId;
    // Get current text from row
    const row=document.querySelector(`.msg-row[data-id="${ctxMsgId}"]`);
    const text=row?.dataset?.text||'';
    document.getElementById('msg-input').value=text;
    document.getElementById('msg-input').focus();
    const bar=document.getElementById('edit-bar');
    bar.classList.add('show');
};

window.cancelEdit = ()=>{
    editingMsgId=null;
    document.getElementById('msg-input').value='';
    document.getElementById('edit-bar').classList.remove('show');
};

window.ctxDelete = async()=>{
    document.getElementById('ctx-menu').style.display='none';
    if(!ctxMsgId||!currentChat) return;
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
    await remove(ref(db,'messages/'+currentChat.id+'/'+ctxMsgId));
};

window.ctxForward = ()=>{
    document.getElementById('ctx-menu').style.display='none';
    if(!ctxMsg) return;
    const list=document.getElementById('fwd-list');
    list.innerHTML='';
    allChats.filter(c=>c.id!==currentChat?.id).forEach(chat=>{
        const name=getChatName(chat);
        const col=avatarColor(name);
        const div=document.createElement('div');
        div.className='fwd-item';
        div.innerHTML=`<div class="avatar" style="width:36px;height:36px;font-size:13px;background:linear-gradient(135deg,${col},${col}88)">${initials(name)}</div><div>${esc(name)}</div>`;
        div.onclick=async()=>{ await forwardMsg(chat); closeModal('modal-fwd'); };
        list.appendChild(div);
    });
    if(!list.children.length) list.innerHTML='<div style="padding:16px;color:var(--text3);font-size:13px;">–ù–µ—Ç –¥—Ä—É–≥–∏—Ö —á–∞—Ç–æ–≤</div>';
    openModal('modal-fwd');
};

async function forwardMsg(toChat){
    const key=await getKey(toChat);
    let text='', isPhoto=false;
    if(ctxMsg.photo){ text=ctxMsg.photo; isPhoto=true; }
    else if(ctxMsgKey&&ctxMsg.enc){ text=await decryptText(ctxMsg.enc,ctxMsgKey)||''; }
    else { text=ctxMsg.text||''; }

    let msgData={ uid:currentUser.uid, senderNick:myNick, timestamp:Date.now(), forwardFrom:ctxMsg.senderNick||myNick };
    if(isPhoto){
        msgData.photo=text; msgData.forwardText='–§–æ—Ç–æ';
    } else {
        msgData.forwardText=text.substring(0,60);
        if(key){ msgData.enc=await encryptText(text,key); }
        else { msgData.text=text; }
    }
    await push(ref(db,'messages/'+toChat.id), msgData);
    await update(ref(db,'chats/'+toChat.id),{ lastMsg:'‚Ü™ –ü–µ—Ä–µ—Å–ª–∞–Ω–æ', lastAt:Date.now() });
}

// ============================================================
// ======= SEARCH & DM / GROUP ================================
// ============================================================
function searchByEmail(val, resId, onClickFn){
    clearTimeout(searchTimer);
    const q=val.trim().toLowerCase();
    const res=document.getElementById(resId);
    if(!q||q.length<3){res.innerHTML='';return;}
    searchTimer=setTimeout(async()=>{
        res.innerHTML='<div style="padding:10px;color:var(--text3);font-size:13px;">–ü–æ–∏—Å–∫...</div>';
        try{
            const snap=await get(ref(db,'users'));
            res.innerHTML='';
            if(!snap.exists()){res.innerHTML='<div style="padding:10px;color:var(--text3);font-size:13px;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';return;}
            const users=Object.entries(snap.val()).map(([uid,u])=>({...u,uid}))
                .filter(u=>u.uid!==currentUser.uid&&(u.email||'').toLowerCase().includes(q));
            if(!users.length){res.innerHTML='<div style="padding:10px;color:var(--text3);font-size:13px;">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';return;}
            users.slice(0,5).forEach(u=>{
                const nick=getNick(u), email=u.email||'';
                const col=avatarColor(nick);
                const div=document.createElement('div');
                div.className='s-result';
                div.innerHTML=`<div class="avatar" style="width:36px;height:36px;font-size:13px;background:linear-gradient(135deg,${col},${col}88)">${initials(nick)}</div><div class="s-result-info"><b>@${esc(nick)} ${u.publicKey?'üîí':''}</b><small>${esc(email)}</small></div>`;
                div.onclick=()=>onClickFn({uid:u.uid,nickName:nick,email});
                res.appendChild(div);
            });
        }catch(e){res.innerHTML='<div style="padding:10px;color:var(--text3);font-size:13px;">–û—à–∏–±–∫–∞</div>';console.error(e);}
    },350);
}

window.searchUserDm=val=>searchByEmail(val,'dm-results',startDm);
window.searchUserGrp=val=>searchByEmail(val,'grp-results',addGrpMember);

async function startDm(other){
    if(!other?.uid){alert('–û—à–∏–±–∫–∞ uid');return;}
    const ex=allChats.find(c=>c.type==='dm'&&c.members?.[currentUser.uid]&&c.members?.[other.uid]);
    if(ex){closeModal('modal-dm');openChat(ex);return;}
    try{
        const chatRef=push(ref(db,'chats'));
        await set(ref(db,'chats/'+chatRef.key),{
            type:'dm',
            members:{[currentUser.uid]:true,[other.uid]:true},
            memberNicks:{[currentUser.uid]:myNick,[other.uid]:other.nickName},
            memberEmails:{[currentUser.uid]:currentUser.email,[other.uid]:other.email},
            createdAt:Date.now(),lastAt:Date.now(),lastMsg:''
        });
        closeModal('modal-dm');
    }catch(e){alert('–û—à–∏–±–∫–∞: '+e.message);console.error(e);}
}

function addGrpMember(u){
    if(groupMembers[u.uid]) return;
    groupMembers[u.uid]={nickName:u.nickName,email:u.email};
    document.getElementById('grp-email').value='';
    document.getElementById('grp-results').innerHTML='';
    renderChips();
}
window.removeGrpMember=uid=>{delete groupMembers[uid];renderChips();};
function renderChips(){
    const el=document.getElementById('grp-chips'); el.innerHTML='';
    Object.entries(groupMembers).forEach(([uid,u])=>{
        const chip=document.createElement('span');
        chip.className='chip';
        chip.innerHTML=`@${esc(u.nickName)} <span class="chip-x" onclick="removeGrpMember('${uid}')">‚úï</span>`;
        el.appendChild(chip);
    });
}
window.createGroup=async()=>{
    const name=document.getElementById('grp-name').value.trim();
    if(!name){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
    const members={[currentUser.uid]:true}, nicks={[currentUser.uid]:myNick}, emails={[currentUser.uid]:currentUser.email};
    Object.entries(groupMembers).forEach(([uid,u])=>{members[uid]=true;nicks[uid]=u.nickName;emails[uid]=u.email;});
    const chatRef=push(ref(db,'chats'));
    await set(ref(db,'chats/'+chatRef.key),{type:'group',name,members,memberNicks:nicks,memberEmails:emails,createdAt:Date.now(),lastAt:Date.now(),lastMsg:''});
    closeModal('modal-group');
    groupMembers={};renderChips();
    document.getElementById('grp-name').value='';
};

// ============================================================
// ======= MODALS =============================================
// ============================================================
window.openModal=id=>{
    if(id==='modal-dm'){document.getElementById('dm-email').value='';document.getElementById('dm-results').innerHTML='';}
    if(id==='modal-group'){groupMembers={};renderChips();document.getElementById('grp-name').value='';document.getElementById('grp-email').value='';document.getElementById('grp-results').innerHTML='';}
    document.getElementById(id).classList.add('open');
};
window.closeModal=id=>document.getElementById(id).classList.remove('open');
document.querySelectorAll('.modal-overlay').forEach(el=>el.addEventListener('click',e=>{if(e.target===el)el.classList.remove('open');}));

// ============================================================
// ======= TABS / FILTER ======================================
// ============================================================
window.setSideTab=(tab,el)=>{
    sideTab=tab;
    document.querySelectorAll('.sb-tab').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    renderChats('');
};
window.filterChats=val=>renderChats(val);
window.goBack=()=>{ document.getElementById('chat-area').classList.remove('slide-in'); };
</script>
</body>
</html>
